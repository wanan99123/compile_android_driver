name: Android 内核驱动编译(完整内核)
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 内核版本
        required: true
        default: '6.6'
        type: choice
        options:
          - '5.10'
          - '5.15'
          - '6.1'
          - '6.6'
          - '6.12'
      android_version:
        description: Android 版本
        required: true
        default: '15'
        type: choice
        options:
          - '12'
          - '13'
          - '14'
          - '15'
          - '16'
      driver_name:
        description: 驱动名（.ko）
        required: true
        default: 'gs_mem.ko'
      target_arch:
        description: 架构
        required: true
        default: 'aarch64'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 准备驱动源码
        run: |
          mkdir -p kerneldriver
          cp ./code/* kerneldriver/ 2>/dev/null || true

      - name: 下载 Android 内核源码
        run: |
          sudo apt install -y repo
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 放入驱动到内核
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/

      - name: 配置 Makefile
        run: |
          cd android-kernel
          sed -i '/kerneldriver/d' common/drivers/Makefile
          echo "obj-m += kerneldriver/" >> common/drivers/Makefile

      - name: 安装编译依赖
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3

      - name: 完整编译内核 + 驱动模块
        id: build_kernel
        run: |
          cd android-kernel/common
          # 关键：ARCH 必须是 arm64，CROSS_COMPILE 是 aarch64-linux-gnu-
          ARCH=arm64
          CROSS_COMPILE=aarch64-linux-gnu-
          JOBS=$(nproc)
          OUT_DIR=$PWD/out

          mkdir -p "$OUT_DIR"

          # 1. 生成 GKI 默认配置
          make O="$OUT_DIR" ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE gki_defconfig

          # 2. 编译内核 Image
          make O="$OUT_DIR" ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j$JOBS Image

          # 3. 只编译你的驱动模块（避免全量编译所有模块）
          make O="$OUT_DIR" ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE M=drivers/kerneldriver -j$JOBS modules

          echo "OUT_DIR=$OUT_DIR" >> $GITHUB_ENV

      - name: 提取驱动 .ko
        id: extract_ko
        run: |
          KO_NAME="${{ github.event.inputs.driver_name }}"
          OUT_PATH="${{ env.OUT_DIR }}"

          # 在输出目录中查找驱动模块
          KO_PATH=$(find "$OUT_PATH" -name "$KO_NAME" -type f | head -1)

          if [ -z "$KO_PATH" ]; then
            echo "Error: $KO_NAME not found in $OUT_PATH!"
            exit 1
          fi

          cp -v "$KO_PATH" ./
          echo "ko_path=./$KO_NAME" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: driver-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}
          path: ${{ steps.extract_ko.outputs.ko_path }}

      - uses: softprops/action-gh-release@v2
        if: success()
        with:
          name: ${{ github.event.inputs.driver_name }} (${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }})
          tag_name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}-${{ github.run_id }}
          files: ${{ steps.extract_ko.outputs.ko_path }}
