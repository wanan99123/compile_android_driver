name: Android 内核驱动编译(make)
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 内核版本
        required: true
        default: '6.6'
        type: choice
        options:
          - '5.10'
          - '5.15'
          - '6.1'
          - '6.6'
          - '6.12'
      android_version:
        description: Android 版本
        required: true
        default: '15'
        type: choice
        options:
          - '12'
          - '13'
          - '14'
          - '15'
          - '16'
      driver_name:
        description: 驱动名（.ko）
        required: true
        default: 'gs_mem.ko'
      target_arch:
        description: 架构
        required: true
        default: 'aarch64'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 准备驱动源码
        run: |
          mkdir -p kerneldriver
          cp ./code/* kerneldriver/ 2>/dev/null || true

      - name: 下载 Android 内核源码
        run: |
          sudo apt install -y repo
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 放入驱动到内核目录
        run: |
          BASE=drivers/kerneldriver
          [ -d android-kernel/common ] && BASE=common/$BASE
          mkdir -p android-kernel/$BASE
          cp -r kerneldriver/* android-kernel/$BASE

      - name: 配置 Makefile
        run: |
          MF=drivers/Makefile
          [ -d android-kernel/common ] && MF=common/$MF
          cd android-kernel
          sed -i '/kerneldriver/d' $MF
          echo "obj-m += kerneldriver/" >> $MF

      - name: 安装编译依赖
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3

      - name: 原生 make 编译内核与驱动
        run: |
          cd android-kernel
          ARCH=${{ github.event.inputs.target_arch }}
          CROSS_COMPILE=aarch64-linux-gnu-
          KERNEL_SRC=$PWD
          OUT_DIR=$PWD/out

          # 进入 common 子目录（如果存在）
          if [ -d common ]; then
            cd common
            KERNEL_SRC=$PWD
            OUT_DIR=$PWD/out
          fi

          # 生成默认配置
          make O=$OUT_DIR ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE gki_defconfig

          # 编译内核与模块
          make O=$OUT_DIR ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j$(nproc)

          echo "OUT_PATH=$OUT_DIR" >> $GITHUB_ENV

      - name: 提取驱动 .ko
        id: extract_ko
        run: |
          KO_NAME="${{ github.event.inputs.driver_name }}"
          OUT_PATH="${{ env.OUT_PATH }}"

          KO_PATH=$(find "$OUT_PATH" -name "$KO_NAME" -type f | head -1)

          if [ -z "$KO_PATH" ]; then
            echo "Error: $KO_NAME not found!"
            exit 1
          fi

          cp -v "$KO_PATH" ./
          echo "ko_path=./$KO_NAME" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: driver-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}
          path: ${{ steps.extract_ko.outputs.ko_path }}

      - uses: softprops/action-gh-release@v2
        if: success()
        with:
          name: ${{ github.event.inputs.driver_name }} (${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }})
          tag_name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}-${{ github.run_id }}
          files: ${{ steps.extract_ko.outputs.ko_path }}
