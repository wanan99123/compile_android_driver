name: Android 内核驱动编译
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 内核版本
        required: true
        default: '6.6'
        type: choice
        options:
          - '5.10'
          - '5.15'
          - '6.1'
          - '6.6'
          - '6.12'
      android_version:
        description: Android 版本
        required: true
        default: '15'
        type: choice
        options:
          - '12'
          - '13'
          - '14'
          - '15'
          - '16'
      driver_name:
        description: 驱动名（.ko）
        required: true
        default: 'gs_mem.ko'
      target_arch:
        description: 架构
        required: true
        default: 'aarch64'
        type: choice
        options:
          - 'aarch64'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 准备驱动源码
        run: |
          mkdir -p kerneldriver
          cp -r ./code/* kerneldriver/ 2>/dev/null || cp *.c *.h Makefile Kconfig kerneldriver/ 2>/dev/null
          ls -la kerneldriver/

      - name: 安装核心依赖（修复 aria2 包名 + 启用 universe 仓库）
        run: |
          # 启用 universe 仓库（解决部分依赖缺失）
          sudo add-apt-repository -y universe
          sudo apt update -qq
          # 正确安装包：aria2（命令是aria2c，包名是aria2）
          sudo apt install -y --no-install-recommends \
            aria2 repo unzip binutils python-is-python3 \
            libssl-dev libelf-dev bc flex bison

      - name: 下载 Clang19 + Rust + build-tools 工具链
        run: |
          mkdir -p toolchain && cd toolchain
          # 下载 Clang19
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/clang-r536225.zip -o clang.zip
          unzip -q clang.zip -d clang19 && rm clang.zip
          # 下载 Rust
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/rust.zip -o rust.zip
          unzip -q rust.zip -d rust && rm rust.zip
          # 下载 build-tools
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang19-r536225/build-tools.zip -o bt.zip
          unzip -q bt.zip -d build-tools && rm bt.zip
          # 配置工具链路径
          echo "PATH=$PWD/clang19/bin:$PWD/build-tools/bin:$PWD/rust/bin:$PATH" >> $GITHUB_ENV

      - name: 拉取内核源码（严格按你指定的命令）
        run: |
          rm -rf android-kernel && mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 内核预处理 + 放入驱动
        run: |
          cd android-kernel
          # 去除 dirty 后缀
          sed -i '/-dirty/d' common/scripts/setlocalversion 2>/dev/null
          # 放入驱动
          TARGET_DIR=common/drivers/kerneldriver
          mkdir -p $TARGET_DIR
          cp -r ../kerneldriver/* $TARGET_DIR/
          # 配置 Makefile
          sed -i '/kerneldriver/d' common/drivers/Makefile
          echo "obj-m += kerneldriver/" >> common/drivers/Makefile

      - name: 配置编译环境变量
        run: |
          echo "ARCH=${{ github.event.inputs.target_arch }}" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV
          echo "RUSTC=rustc" >> $GITHUB_ENV
          echo "CARGO=cargo" >> $GITHUB_ENV

      - name: 编译内核与驱动（纯 Make 方式）
        run: |
          cd android-kernel/common
          make gki_defconfig
          scripts/config --enable MODULES
          scripts/config --enable MODULE_UNLOAD
          echo "CONFIG_GS_MEM=m" >> .config
          # 先编译内核生成依赖文件
          make -j$(nproc)
          # 编译驱动模块
          make M=drivers/kerneldriver modules -j$(nproc)

      - name: 提取驱动文件
        id: extract_ko
        run: |
          KO=${{ github.event.inputs.driver_name }}
          KO_PATH=$(find android-kernel -name $KO -type f | head -1)
          if [ -z "$KO_PATH" ]; then
            echo "❌ 未找到驱动文件 $KO"
            exit 1
          fi
          cp -v $KO_PATH ./
          echo "ko_path=./$KO" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: driver-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}
          path: ${{ steps.extract_ko.outputs.ko_path }}

      - name: 创建 Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: build-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}-${{ github.run_id }}
          files: ${{ steps.extract_ko.outputs.ko_path }}
          generate_release_notes: true
