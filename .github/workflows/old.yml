name: Android 内核驱动编译(make+clang18)
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 内核版本
        required: true
        default: '6.6'
        type: choice
        options:
          - '5.10'
          - '5.15'
          - '6.1'
          - '6.6'
          - '6.12'
      android_version:
        description: Android 版本
        required: true
        default: '15'
        type: choice
        options:
          - '12'
          - '13'
          - '14'
          - '15'
          - '16'
      driver_name:
        description: 驱动名（.ko）
        required: true
        default: 'gs_mem.ko'
      target_arch:
        description: 架构
        required: true
        default: 'aarch64'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 准备驱动源码
        run: |
          mkdir -p kerneldriver
          cp ./code/* kerneldriver/ 2>/dev/null || true

      - name: 下载内核源码
        run: |
          git clone --depth=1 -b android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            https://android.googlesource.com/kernel/common android-kernel

      - name: 下载 Clang 18
        run: |
          mkdir -p android-clang
          cd android-clang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r510928.tar.gz
          tar xf clang-r510928.tar.gz
          echo "CLANG_PATH=$PWD" >> $GITHUB_ENV

      - name: 放入驱动
        run: |
          mkdir -p android-kernel/drivers/kerneldriver
          cp -r kerneldriver/* android-kernel/drivers/kerneldriver/

      - name: 配置 Makefile
        run: |
          cd android-kernel
          sed -i '/kerneldriver/d' drivers/Makefile
          echo "obj-m += kerneldriver/" >> drivers/Makefile

      - name: 安装依赖
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu

      - name: 编译驱动（Clang 18）
        run: |
          cd android-kernel
          ARCH=arm64
          CLANG_PATH=${{ env.CLANG_PATH }}
          CROSS_COMPILE=aarch64-linux-gnu-

          make ARCH=$ARCH \
            CC=$CLANG_PATH/bin/clang \
            LD=$CLANG_PATH/bin/ld.lld \
            AR=$CLANG_PATH/bin/llvm-ar \
            NM=$CLANG_PATH/bin/llvm-nm \
            OBJCOPY=$CLANG_PATH/bin/llvm-objcopy \
            OBJDUMP=$CLANG_PATH/bin/llvm-objdump \
            CROSS_COMPILE=$CROSS_COMPILE \
            gki_defconfig

          make ARCH=$ARCH \
            CC=$CLANG_PATH/bin/clang \
            LD=$CLANG_PATH/bin/ld.lld \
            CROSS_COMPILE=$CROSS_COMPILE \
            modules -j$(nproc)

      - name: 提取 .ko
        id: extract_ko
        run: |
          KO_NAME="${{ github.event.inputs.driver_name }}"
          find android-kernel -name "$KO_NAME" -type f | head -1 | xargs cp -t .
          echo "ko_path=./$KO_NAME" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: driver-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}
          path: ${{ steps.extract_ko.outputs.ko_path }}

      - uses: softprops/action-gh-release@v2
        if: success()
        with:
          name: ${{ github.event.inputs.driver_name }} (${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }})
          tag_name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.kernel_version }}-android${{ github.event.inputs.android_version }}-${{ github.run_id }}
          files: ${{ steps.extract_ko.outputs.ko_path }}
