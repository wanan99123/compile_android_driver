name: 自定义GKI内核构建(仅SukiSU·KPM专用)

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: '安卓版本 (例: 15)'
        required: true
        default: '15'
        type: string

      kernel_version:
        description: '内核版本 (例: 6.6)'
        required: true
        default: '6.6'
        type: string

      kpm_enable:
        description: '启用KPM内核模块框架'
        required: true
        type: boolean
        default: true

      lz4_enable:
        description: '开启LZ4+ZSTD压缩优化'
        required: true
        type: boolean
        default: true

      bbr_enable:
        description: 'BBR网络加速'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'

      adios_enable:
        description: '启用ADIOS IO调度'
        required: true
        type: boolean
        default: true

      baseband_guard:
        description: '内核级基带保护(防格机)'
        required: true
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: |
          sudo apt update -qq
          sudo apt install -y git curl make bc bison flex libssl-dev libelf-dev zip unzip

      - name: 下载Google GKI内核
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common \
            -b android${{ inputs.android_version }}-${{ inputs.kernel_version }} common

      - name: 去除dirty后缀 & ABI保护
        run: |
          rm -f common/android/abi_gki_protected_exports_*
          sed -i 's/ -dirty//g' common/scripts/setlocalversion

      - name: 集成 SukiSU Ultra
        run: |
          cd common
          curl -LSs https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh | bash -s builtin

      - name: 集成 KPM
        run: |
          cd common
          if [[ "${{ inputs.kpm_enable }}" == "true" ]]; then
            curl -LSs https://raw.githubusercontent.com/587899/KPM/main/apply.sh | bash -s -- -k
          fi

      - name: 编译内核
        run: |
          cd common
          ARCH=arm64
          CROSS_COMPILE=aarch64-linux-gnu-
          JOBS=$(nproc)
          OUT=out
          mkdir -p $OUT

          make O=$OUT ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE gki_defconfig

          scripts/config --file $OUT/.config -e CONFIG_KSU

          if [[ "${{ inputs.kpm_enable }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_KPM
          fi

          if [[ "${{ inputs.lz4_enable }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_LZ4
            scripts/config --file $OUT/.config -e CONFIG_ZSTD
            scripts/config --file $OUT/.config -e CONFIG_CRYPTO_LZ4
            scripts/config --file $OUT/.config -e CONFIG_CRYPTO_ZSTD
          fi

          if [[ "${{ inputs.bbr_enable }}" != "false" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_TCP_CONG_BBR
            if [[ "${{ inputs.bbr_enable }}" == "default" ]]; then
              scripts/config --file $OUT/.config --set-str CONFIG_DEFAULT_TCP_CONG bbr
            fi
          fi

          if [[ "${{ inputs.adios_enable }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_IOSCHED_ADIOS
            scripts/config --file $OUT/.config --set-str CONFIG_DEFAULT_IOSCHED adios
          fi

          if [[ "${{ inputs.baseband_guard }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_ALWAYS_DENY_DEV_MEM
          fi

          make O=$OUT ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j$JOBS Image

      - name: 提取 boot.img
        run: |
          cp common/out/arch/arm64/boot/Image ./boot.img

      - name: 打包AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cp boot.img AnyKernel3/
          cd AnyKernel3
          zip -r9 ../GKI_boot.zip ./*

      - name: 上传内核
        uses: actions/upload-artifact@v4
        with:
          name: GKI_BOOT
          path: |
            boot.img
            GKI_boot.zip
