name: 一加 Ace6 专用 Google6.6 内核(无缓存·全功能)

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支(ReSukiSU/SukiSU Ultra/KSU原版/无)'
        required: true
        type: choice
        default: 'resukisu'
        options:
          - 'resukisu'
          - 'sukisu'
          - 'ksu'
          - 'none'
      kpm_enable:
        description: '是否开启kPM(false关闭/builtin内置)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'builtin'
      susfs_enable:
        description: '开启SUSFS增强隐藏'
        required: true
        type: boolean
        default: true
      lz4_enable:
        description: '开启LZ4+ZSTD压缩'
        required: true
        type: boolean
        default: true
      bbr_enable:
        description: 'BBR网络(false关/true开/default默认)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: '开启网络扩展iptables/ipset'
        required: true
        type: boolean
        default: false
      adios_enable:
        description: '开启ADIOS IO调度'
        required: true
        type: boolean
        default: true
      baseband_guard:
        description: '开启基带保护(防格机)'
        required: true
        type: boolean
        default: true
      kernel_suffix:
        description: '内核后缀(可不填)'
        required: false
        type: string
        default: ''

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: |
          sudo apt update -qq
          sudo apt install -y git curl make bc bison flex libssl-dev libelf-dev zip unzip

      - name: 下载 Google 官方 android15-6.6 内核
        run: |
          git clone --depth=1 https://android.googlesource.com/kernel/common -b android15-6.6 common

      - name: 集成 KernelSU
        run: |
          cd common
          if [[ "${{ inputs.ksu_type }}" == "resukisu" ]]; then
            curl -LSs https://raw.githubusercontent.com/ReSukiSU/ReSukiSU/main/kernel/setup.sh | bash -s main
          elif [[ "${{ inputs.ksu_type }}" == "sukisu" ]]; then
            curl -LSs https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh | bash -s builtin
          elif [[ "${{ inputs.ksu_type }}" == "ksu" ]]; then
            curl -LSs https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh | bash -s main
          fi

      - name: 集成 KPM
        run: |
          cd common
          if [[ "${{ inputs.kpm_enable }}" == "builtin" ]]; then
            curl -LSs https://raw.githubusercontent.com/587899/KPM/main/apply.sh | bash -s -- -k
          fi

      - name: 编译内核(仅boot·不编译任何ko)
        run: |
          cd common
          ARCH=arm64
          CROSS_COMPILE=aarch64-linux-gnu-
          JOBS=$(nproc)
          OUT=out
          mkdir -p $OUT

          make O=$OUT ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE gki_defconfig

          # KSU
          if [[ "${{ inputs.ksu_type }}" != "none" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_KSU
          fi

          # KPM
          if [[ "${{ inputs.kpm_enable }}" == "builtin" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_KPM
          fi

          # LZ4 + ZSTD
          if [[ "${{ inputs.lz4_enable }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_LZ4
            scripts/config --file $OUT/.config -e CONFIG_ZSTD
            scripts/config --file $OUT/.config -e CONFIG_CRYPTO_LZ4
            scripts/config --file $OUT/.config -e CONFIG_CRYPTO_ZSTD
          fi

          # BBR
          if [[ "${{ inputs.bbr_enable }}" != "false" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_TCP_CONG_BBR
            if [[ "${{ inputs.bbr_enable }}" == "default" ]]; then
              scripts/config --file $OUT/.config --set-str CONFIG_DEFAULT_TCP_CONG bbr
            fi
          fi

          # 网络扩展
          if [[ "${{ inputs.better_net }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_NETFILTER_XT_SET
            scripts/config --file $OUT/.config -e CONFIG_IP_SET
          fi

          # ADIOS IO调度
          if [[ "${{ inputs.adios_enable }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_IOSCHED_ADIOS
            scripts/config --file $OUT/.config --set-str CONFIG_DEFAULT_IOSCHED adios
          fi

          # 基带保护
          if [[ "${{ inputs.baseband_guard }}" == "true" ]]; then
            scripts/config --file $OUT/.config -e CONFIG_ALWAYS_DENY_DEV_MEM
          fi

          # 只编译内核，不编译任何模块
          make O=$OUT ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j$JOBS Image

      - name: 提取 boot.img
        run: |
          cp common/out/arch/arm64/boot/Image ./boot.img

      - name: 打包 Recovery 卡刷包
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cp boot.img AnyKernel3/
          cd AnyKernel3
          zip -r9 ../Boot_Android15_6.6_GKI.zip ./*

      - name: 上传内核
        uses: actions/upload-artifact@v4
        with:
          name: Boot_Android15_6.6
          path: |
            boot.img
            Boot_Android15_6.6_GKI.zip
