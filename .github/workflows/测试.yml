name: GKI KernelSU + KPM + SUSFS + BBR + 基带防格机 编译(repo+build.sh)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android 版本 (13/14)'
        required: true
        default: '13'
      kernel_version:
        description: '内核版本 (如 5.10, 6.1, 6.12)'
        required: true
        default: '5.10'
      target_arch:
        description: '架构 (aarch64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 安装完整编译依赖（含LLVM/LLD）
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3 repo zip curl lld llvm

      - name: 下载 Android 内核源码
        run: |
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 集成 KernelSU 补丁（按输入版本自动拉取）
        run: |
          cd android-kernel/common
          git clone https://mirror.ghproxy.com/https://github.com/tiann/KernelSU.git KernelSU
          
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          if [ -d "KernelSU/patches/$KERNEL_VER" ]; then
            PATCH_DIR="$KERNEL_VER"
          elif [ -d "KernelSU/patches/${KERNEL_VER%.*}" ]; then
            PATCH_DIR="${KERNEL_VER%.*}"
          else
            echo "❌ 未找到适用于 $KERNEL_VER 的 KernelSU 补丁"
            exit 1
          fi
          
          echo "✅ 应用 $KERNEL_VER 对应的 KernelSU 补丁..."
          git am --3way KernelSU/patches/$PATCH_DIR/*.patch || true

      - name: 集成 SUSFS 补丁（按输入版本自动拉取）
        run: |
          cd android-kernel/common
          git clone https://mirror.ghproxy.com/https://github.com/yc9559/SUSFS.git SUSFS
          
          KERNEL_VER="${{ github.event.inputs.kernel_version }}"
          if [ -d "SUSFS/patches/$KERNEL_VER" ]; then
            PATCH_DIR="$KERNEL_VER"
          elif [ -d "SUSFS/patches/${KERNEL_VER%.*}" ]; then
            PATCH_DIR="${KERNEL_VER%.*}"
          else
            echo "❌ 未找到适用于 $KERNEL_VER 的 SUSFS 补丁"
            exit 1
          fi
          
          echo "✅ 应用 $KERNEL_VER 对应的 SUSFS 补丁..."
          git am --3way SUSFS/patches/$PATCH_DIR/*.patch || {
            echo "⚠️ 补丁应用失败，可能存在冲突，请手动解决"
            exit 1
          }

      - name: 生成.config并动态开启所有功能
        run: |
          COMMON_DIR="${GITHUB_WORKSPACE}/android-kernel/common"
          OUT_DIR="${GITHUB_WORKSPACE}/android-kernel/out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/common"
          
          make -C "${COMMON_DIR}" LLVM=1 DEPMOD=depmod \
            DTC="${GITHUB_WORKSPACE}/android-kernel/build/kernel/build-tools/path/linux-x86/dtc" \
            O="${OUT_DIR}" \
            gki_defconfig
          
          # 开启 KSU + KPM
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable KSU
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable KSU_KPM

          # 开启 SUSFS
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable SUSFS
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable SUSFS_DEBUG

          # BBR 网络加速
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable TCP_CONG_BBR
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --set-str DEFAULT_TCP_CONG bbr
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable NET_SCH_FQ_CODEL

          # 基带防格机
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable MDM_PROTECT
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable EFS_PROTECT
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable IMEI_PROTECT
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable BLOCK_UNSAFE_PARTITION_WRITE
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable SECURITY_FS_PROTECT
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable QCOM_EFS_PROTECT

          # 内存/IO 优化
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable ZRAM
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable ZRAM_DEF_COMP_LZ4

      - name: 编译内核与驱动（原版脚本+环境加固）
        run: |
          cd android-kernel
          export KMI_STRICT_MODE=0
          export PATH="/usr/bin/llvm-config:/usr/bin:$PATH"
          ANDROID_VER=${{ github.event.inputs.android_version }}
          ARCH=${{ github.event.inputs.target_arch }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}

          if [ "$ANDROID_VER" -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${ARCH} LTO=thin build/build.sh -j$(nproc)
            OUT_PATH="out/android${ANDROID_VER}-${KERNEL_VER}/dist"
          else
            tools/bazel run //common:kernel_${ARCH}_dist
            OUT_PATH="out/kernel_${ARCH}/dist"
          fi

          echo "OUT_PATH=$OUT_PATH" >> $GITHUB_ENV

      - name: 拉取 AnyKernel3 打包工具
        run: |
          git clone --depth=1 https://mirror.ghproxy.com/https://github.com/osm0sis/AnyKernel3.git ak3

      - name: 打包可刷入 ZIP
        run: |
          cp "android-kernel/${{ env.OUT_PATH }}/Image.gz" ak3/
          cd ak3
          zip -r9 "GKI-Android${{ github.event.inputs.android_version }}-Kernel${{ github.event.inputs.kernel_version }}-KSU-KPM-SUSFS-BBR.zip" * -x .git README.md placeholder

      - name: 上传到 GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: "ak3/GKI-Android${{ github.event.inputs.android_version }}-Kernel${{ github.event.inputs.kernel_version }}-KSU-KPM-SUSFS-BBR.zip"
          tag_name: Build-${{ github.run_number }}
          name: GKI ${KERNEL_VER} (Android ${ANDROID_VER}) + KSU + KPM + SUSFS + BBR
          body: |
            ✅ 编译环境：Ubuntu 22.04 + LLVM/LLD
            ✅ 核心功能：KernelSU | KPM | SUSFS | BBR
            ✅ 安全防护：基带防格机 | IMEI 保护
            ✅ 附加优化：FQ_CODEL | ZRAM (LZ4)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANDROID_VER: ${{ github.event.inputs.android_version }}
          KERNEL_VER: ${{ github.event.inputs.kernel_version }}
