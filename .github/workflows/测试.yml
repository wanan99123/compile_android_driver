name: GKI KernelSU + KPM 编译(repo+build.sh)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android 版本 (13/14/15)'
        required: true
        default: '14'
      kernel_version:
        description: '内核版本 (5.10/6.1/6.6)'
        required: true
        default: '6.6'
      target_arch:
        description: '架构 (aarch64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 安装依赖
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3 repo zip curl lld llvm

      - name: 下载 Android 内核源码
        run: |
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 集成 KernelSU
        run: |
          cd android-kernel/common
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          rm -f android/abi_gki_protected_exports_* 2>/dev/null || true

      - name: 添加额外配置文件 (解决 bazel 校验报错)
        run: |
          cd android-kernel/common
          mkdir -p kernel/configs
          echo "CONFIG_KSU=y" >> kernel/configs/ksu.config
          echo "CONFIG_KSU_KPM=y" >> kernel/configs/ksu.config

      - name: 编译内核 (原版逻辑不变)
        run: |
          cd android-kernel
          export KMI_STRICT_MODE=0
          export PATH="/usr/bin/llvm-config:/usr/bin:$PATH"
          export GKI_KERNEL_ADDITIONAL_CONFIG=kernel/configs/ksu.config

          ANDROID_VER=${{ github.event.inputs.android_version }}
          ARCH=${{ github.event.inputs.target_arch }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}

          if [ "$ANDROID_VER" -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${ARCH} LTO=thin build/build.sh -j$(nproc)
            echo "OUT_PATH=out/android${ANDROID_VER}-${KERNEL_VER}/dist" >> $GITHUB_ENV
          else
            tools/bazel run //common:kernel_${ARCH}_dist
            echo "OUT_PATH=out/kernel_${ARCH}/dist" >> $GITHUB_ENV
          fi

          echo "BOOT_IMG=boot-A${ANDROID_VER}-K${KERNEL_VER}-KSU-KPM.img" >> $GITHUB_ENV

      - name: 复制镜像
        run: |
          cp "android-kernel/${{ env.OUT_PATH }}/boot.img" "${{ env.BOOT_IMG }}"
          ls -lh ${{ env.BOOT_IMG }}

      - name: 上传 Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.BOOT_IMG }}
          tag_name: Build-${{ github.run_number }}
          name: GKI ${{ github.event.inputs.kernel_version }} (Android ${{ github.event.inputs.android_version }}) + KSU + KPM
          body: |
            ✅ 编译环境：Ubuntu 22.04 + LLVM/LLD
            ✅ 功能：KernelSU 已集成 | KPM 已启用
            ✅ 编译方式：build.sh / bazel 原版不变
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
