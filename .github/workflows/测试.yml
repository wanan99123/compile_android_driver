name: GKI KernelSU + KPM 编译(repo+build.sh)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android 版本 (13/14)'
        required: true
        default: '13'
      kernel_version:
        description: '内核版本 (5.10/6.12)'
        required: true
        default: '5.10'
      target_arch:
        description: '架构 (aarch64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 安装编译依赖
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3 repo zip curl

      - name: 下载 Android 内核源码
        run: |
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: 集成 KernelSU 补丁
        run: |
          cd android-kernel/common
          git clone https://github.com/tiann/KernelSU.git KernelSU
          git am --3way KernelSU/patches/${{ github.event.inputs.kernel_version }}/*.patch || true

      - name: 开启 KSU + KPM
        run: |
          cd android-kernel
          ANDROID_VER=${{ github.event.inputs.android_version }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}
          ARCH=${{ github.event.inputs.target_arch }}

          # 先生成标准 gki_defconfig
          make -C common LLVM=1 DEPMOD=depmod \
            DTC=../build/kernel/build-tools/path/linux-x86/dtc \
            O=../out/android${ANDROID_VER}-${KERNEL_VER}/common \
            gki_defconfig

          # 用内核自带工具动态开启 KSU，不修改原始gki_defconfig
          cd out/android${ANDROID_VER}-${KERNEL_VER}/common
          ../../common/scripts/config --enable KSU
          ../../common/scripts/config --enable KSU_KPM

      - name: 编译内核与驱动（你提供的原版脚本）
        run: |
          cd android-kernel
          export KMI_STRICT_MODE=0
          ANDROID_VER=${{ github.event.inputs.android_version }}
          ARCH=${{ github.event.inputs.target_arch }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}

          if [ "$ANDROID_VER" -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${ARCH} LTO=thin build/build.sh -j32
            OUT_PATH="out/android${ANDROID_VER}-${KERNEL_VER}/dist"
          else
            tools/bazel run //common:kernel_${ARCH}_dist
            OUT_PATH="out/kernel_${ARCH}/dist"
          fi

          echo "OUT_PATH=$OUT_PATH" >> $GITHUB_ENV

      - name: 拉取 AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3

      - name: 打包刷机包
        run: |
          cp android-kernel/${OUT_PATH}/Image.gz ak3/
          cd ak3
          zip -r9 GKI-${{ github.event.inputs.kernel_version }}-KSU-KPM.zip * -x .git README.md placeholder

      - name: 上传到 Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ak3/GKI-${{ github.event.inputs.kernel_version }}-KSU-KPM.zip
          tag_name: GKI-${{ github.event.inputs.kernel_version }}-KSU-KPM-${{ github.run_number }}
          name: GKI ${{ github.event.inputs.kernel_version }} + KSU + KPM
          body: |
            ✅ Android ${{ github.event.inputs.android_version }}
            ✅ KernelSU + KPM 已开启
            ✅ AnyKernel3 打包
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
