name: GKI 5.10 (Android13) + KernelSU + KPM 编译

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt install -y git bc bison flex libssl-dev libelf-dev make gcc zip curl

      - name: 拉取清华源 GKI 5.10 (Android13分支)
        run: |
          # 修正核心地址：补充platform层级，这是仓库不存在的根本原因
          git clone https://mirrors.tuna.tsinghua.edu.cn/git/android/platform/kernel/common.git -b android13-5.10 kernel

      - name: 集成 KernelSU 并打补丁
        run: |
          cd kernel
          git clone https://github.com/tiann/KernelSU.git KernelSU
          # 3way合并解决冲突，失败则手动终止（避免无效编译）
          git am --3way KernelSU/patches/5.10/*.patch

      - name: 开启 KernelSU + KPM 配置
        run: |
          cd kernel
          # 追加配置到GKI默认配置
          echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_KPM=y" >> arch/arm64/configs/gki_defconfig

      - name: 下载适配的Clang工具链（Android13 GKI专用）
        run: |
          # 修正工具链拉取路径，避免版本不兼容
          git clone --depth=1 https://mirrors.tuna.tsinghua.edu.cn/git/android/platform/prebuilts/clang/host/linux-x86.git clang
          # 选用Android13 GKI编译标准的r416183b版本
          mv clang/clang-r416183b clang-toolchain

      - name: 编译内核
        run: |
          cd kernel
          export ARCH=arm64
          export PATH=$GITHUB_WORKSPACE/clang-toolchain/bin:$PATH
          # 加载配置
          make gki_defconfig
          # 多线程编译，指定Clang工具链
          make -j$(nproc) CC=clang AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: 拉取AnyKernel3打包工具
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3

      - name: 打包为可刷入ZIP
        run: |
          # 复制编译好的内核镜像（GKI 5.10标准输出为Image.gz）
          cp kernel/arch/arm64/boot/Image.gz ak3/
          cd ak3
          # 排除无用文件，生成刷机包
          zip -r9 GKI-5.10-Android13-KSU-KPM.zip * -x .git README.md placeholder

      - name: 上传到GitHub Releases
        uses: softprops/action-gh-release@v2  # 修正原Action名称错误
        with:
          files: ak3/GKI-5.10-Android13-KSU-KPM.zip
          tag_name: Build-${{ github.run_number }}-${{ github.run_id }}
          name: GKI 5.10 Android13 编译版 #${{ github.run_number }}
          body: |
            ✅ 内核版本：5.10 (Android13 GKI)
            ✅ 源码来源：清华镜像站
            ✅ 功能：KernelSU + KPM 已启用
            ✅ 打包工具：AnyKernel3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
