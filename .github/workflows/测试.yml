name: GKI KernelSU + KPM ç¼–è¯‘(repo+build.sh)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android ç‰ˆæœ¬ (13/14)'
        required: true
        default: '13'
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (5.10/6.1)'
        required: true
        default: '5.10'
      target_arch:
        description: 'æ¶æ„ (aarch64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–ï¼ˆå«LLVM/LLDï¼‰
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3 repo zip curl lld llvm

      - name: ä¸‹è½½ Android å†…æ ¸æºç 
        run: |
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: é›†æˆ KernelSU è¡¥ä¸
        run: |
          cd android-kernel/common
          git clone https://github.com/tiann/KernelSU.git KernelSU
          git am --3way KernelSU/patches/${{ github.event.inputs.kernel_version }}/*.patch || true

      - name: ç”Ÿæˆ.configå¹¶åŠ¨æ€å¼€å¯ KSU + KPMï¼ˆä¿®å¤è·¯å¾„+LLVMï¼‰
        run: |
          # å®šä¹‰ç»å¯¹è·¯å¾„ï¼Œå½»åº•è§£å†³è·¯å¾„é”™ä½é—®é¢˜
          COMMON_DIR="${GITHUB_WORKSPACE}/android-kernel/common"
          OUT_DIR="${GITHUB_WORKSPACE}/android-kernel/out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/common"
          
          # å…ˆç”Ÿæˆæ ‡å‡† gki_defconfigï¼ˆæŒ‡å®šLLVMå·¥å…·ï¼‰
          make -C "${COMMON_DIR}" LLVM=1 DEPMOD=depmod \
            DTC="${GITHUB_WORKSPACE}/android-kernel/build/kernel/build-tools/path/linux-x86/dtc" \
            O="${OUT_DIR}" \
            gki_defconfig
          
          # ä½¿ç”¨ç»å¯¹è·¯å¾„è°ƒç”¨ scripts/configï¼Œé¿å…ç›¸å¯¹è·¯å¾„é”™è¯¯
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable KSU
          "${COMMON_DIR}/scripts/config" --file "${OUT_DIR}/.config" --enable KSU_KPM

      - name: ç¼–è¯‘å†…æ ¸ä¸é©±åŠ¨ï¼ˆåŸç‰ˆè„šæœ¬+ç¯å¢ƒåŠ å›ºï¼‰
        run: |
          cd android-kernel
          export KMI_STRICT_MODE=0
          export PATH="/usr/bin/llvm-config:/usr/bin:$PATH"
          ANDROID_VER=${{ github.event.inputs.android_version }}
          ARCH=${{ github.event.inputs.target_arch }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}

          if [ "$ANDROID_VER" -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${ARCH} LTO=thin build/build.sh -j$(nproc)
            echo "OUT_PATH=out/android${ANDROID_VER}-${KERNEL_VER}/dist" >> $GITHUB_ENV
          else
            tools/bazel run //common:kernel_${ARCH}_dist
            echo "OUT_PATH=out/kernel_${ARCH}/dist" >> $GITHUB_ENV
          fi

          # å®šä¹‰ç»Ÿä¸€çš„ Boot é•œåƒåç§°ï¼Œæ–¹ä¾¿åç»­ä¸Šä¼ 
          echo "BOOT_IMG=boot-A${ANDROID_VER}-K${KERNEL_VER}-KSU-KPM.img" >> $GITHUB_ENV

      - name: é‡å‘½å Boot é•œåƒï¼ˆå¯é€‰ï¼Œä¾¿äºè¯†åˆ«ï¼‰
        run: |
          cp "android-kernel/${{ env.OUT_PATH }}/boot.img" "${{ env.BOOT_IMG }}"
          ls -lh ${{ env.BOOT_IMG }}

      - name: ä¸Šä¼ åˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          # ç›´æ¥ä¸Šä¼ é‡å‘½ååçš„ boot.img
          files: ${{ env.BOOT_IMG }}
          tag_name: Build-${{ github.run_number }}
          # ä¿®å¤å˜é‡å¼•ç”¨ï¼Œä½¿ç”¨ github.event.inputs è€Œéç¯å¢ƒå˜é‡
          name: GKI ${{ github.event.inputs.kernel_version }} (Android ${{ github.event.inputs.android_version }}) + KSU + KPM
          body: |
            âœ… ç¼–è¯‘ç¯å¢ƒï¼šUbuntu 22.04 + LLVM/LLD
            âœ… åŠŸèƒ½ï¼šKernelSU å·²é›†æˆ | KPM å·²å¯ç”¨
            ğŸ“¦ äº§ç‰©ï¼šboot.imgï¼ˆé€‚ç”¨äº Fastboot åˆ·å…¥ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
