name: GKI KernelSU + KPM ç¼–è¯‘(repo+build.sh)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android ç‰ˆæœ¬ (13/14)'
        required: true
        default: '13'
      kernel_version:
        description: 'å†…æ ¸ç‰ˆæœ¬ (5.10/6.1)'
        required: true
        default: '5.10'
      target_arch:
        description: 'æ¶æ„ (aarch64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -qq
          sudo apt install -y build-essential flex bison libssl-dev libelf-dev bc gcc-aarch64-linux-gnu python-is-python3 repo zip curl lld llvm

      - name: ä¸‹è½½ Android å†…æ ¸æºç 
        run: |
          rm -rf android-kernel
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest \
            -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }} \
            --depth=1
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      # =======================
      # è¿™é‡Œæ˜¯ä¿®å¤é‡ç‚¹ï¼šæ­£ç¡®é›†æˆ KSU
      # =======================
      - name: é›†æˆ KernelSUï¼ˆå®˜æ–¹setupï¼Œç¨³å®šä¸å¤±è´¥ï¼‰
        run: |
          cd android-kernel/common
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          
          # å¿…é¡»ï¼šè§£é™¤ GKI ABI ä¿æŠ¤ï¼Œå¦åˆ™ KSU ä¸ç”Ÿæ•ˆ
          rm -f android/abi_gki_protected_exports_* 2>/dev/null

      # =======================
      # ä¿®å¤ï¼šæ­£ç¡®å¼€å¯ KSU + KPM
      # =======================
      - name: å¼€å¯ KSU + KPM é…ç½®
        run: |
          cd android-kernel/common
          echo "CONFIG_KSU=y" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KSU_KPM=y" >> arch/arm64/configs/gki_defconfig

      # =======================
      # å®Œå…¨ä¿ç•™ä½ åŸæ¥çš„ç¼–è¯‘æ–¹å¼ä¸åŠ¨
      # =======================
      - name: ç¼–è¯‘å†…æ ¸ï¼ˆåŸç‰ˆ build.sh / bazelï¼‰
        run: |
          cd android-kernel
          export KMI_STRICT_MODE=0
          export PATH="/usr/bin/llvm-config:/usr/bin:$PATH"
          ANDROID_VER=${{ github.event.inputs.android_version }}
          ARCH=${{ github.event.inputs.target_arch }}
          KERNEL_VER=${{ github.event.inputs.kernel_version }}

          if [ "$ANDROID_VER" -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${ARCH} LTO=thin build/build.sh -j$(nproc)
            echo "OUT_PATH=out/android${ANDROID_VER}-${KERNEL_VER}/dist" >> $GITHUB_ENV
          else
            tools/bazel run //common:kernel_${ARCH}_dist
            echo "OUT_PATH=out/kernel_${ARCH}/dist" >> $GITHUB_ENV
          fi

          echo "BOOT_IMG=boot-A${ANDROID_VER}-K${KERNEL_VER}-KSU-KPM.img" >> $GITHUB_ENV

      - name: å¤åˆ¶é•œåƒ
        run: |
          cp "android-kernel/${{ env.OUT_PATH }}/boot.img" "${{ env.BOOT_IMG }}"
          ls -lh ${{ env.BOOT_IMG }}

      - name: ä¸Šä¼  Releases
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.BOOT_IMG }}
          tag_name: Build-${{ github.run_number }}
          name: GKI ${{ github.event.inputs.kernel_version }} (Android ${{ github.event.inputs.android_version }}) + KSU + KPM
          body: |
            âœ… ç¼–è¯‘ç¯å¢ƒï¼šUbuntu 22.04 + LLVM/LLD
            âœ… åŠŸèƒ½ï¼šKernelSU å·²é›†æˆ | KPM å·²å¯ç”¨
            ğŸ“¦ äº§ç‰©ï¼šboot.imgï¼ˆFastboot åˆ·å…¥ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}